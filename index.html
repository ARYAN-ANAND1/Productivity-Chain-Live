<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Productivity Chain Tracker (4-Level)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom styles and Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'current-day-blue': '#3b82f6', // Blue 500
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            padding: 1rem;
        }

        .panel { width:100%; max-width:960px; margin:auto; }

        #calendar-scroll {
            max-height: 72vh;
            overflow-y: auto;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 8px;
            align-items: start;
        }

        .date-tile {
            width: 100%;
            padding-top: 100%;
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            transition: all .18s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            background-color: #ffffff;
            color: #374151;
        }
        
        .date-tile:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08); }


        .date-tile-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* --- 4 LEVEL STATUS STYLES --- */
        
        /* Dark Green: Happy with work (Maximum Productivity) */
        .status-dark-green {
            background-color: #059669; /* Emerald 600 */
            color: #ffffff !important;
            box-shadow: 0 6px 12px -6px rgba(5, 150, 105, 0.3);
        }
        
        /* Light Green: Did work, not satisfied (Satisfactory Productivity) */
        .status-light-green {
            background-color: #a7f3d0; /* Emerald 200 */
            color: #064e3b !important; /* Dark text for contrast */
            box-shadow: 0 6px 12px -6px rgba(167, 243, 208, 0.3);
        }

        /* Light Red: Did work, very little (Minimal Productivity) */
        .status-light-red {
            background-color: #fecaca; /* Red 200 */
            color: #7f1d1d !important; /* Dark text for contrast */
            box-shadow: 0 6px 12px -6px rgba(254, 202, 202, 0.3);
        }

        /* Deep Red: Wasted time (Maximum Unproductive) */
        .status-deep-red {
            background-color: #ef4444; /* Red 500 */
            color: #ffffff !important;
            box-shadow: 0 6px 12px -6px rgba(239,68,68,0.3);
        }

        /* --- END 4 LEVEL STATUS STYLES --- */


        .today {
            border: 3px solid #3b82f6;
        }
        
        .month-header {
            grid-column: 1 / -1;
            text-align: left;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 1.05rem;
            font-weight: 700;
            color: #111827;
            position: sticky;
            top: 0;
            z-index: 8;
            padding: 0.25rem 0.5rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        /* smaller mobile spacing */
        @media (max-width:640px) {
            .calendar-grid { gap:6px; grid-template-columns: repeat(auto-fill, minmax(42px,1fr)); }
        }

    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, Timestamp, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIG AREA ===
        // --------------------------------------------------------------------------
        // YOUR LIVE FIREBASE CONFIGURATION (COPIED FROM FIREBASE PROJECT SETTINGS)
        // This configuration enables cloud synchronization for permanent data storage.
        // --------------------------------------------------------------------------
        const providedFirebaseConfig = {
          apiKey: "AIzaSyD4xb2vKjVl6lBnfr_R0lMdRtMMn15K2U",
          authDomain: "productivity-tracker-53afe.firebaseapp.com",
          projectId: "productivity-tracker-53afe",
          storageBucket: "productivity-tracker-53afe.appspot.com",
          messagingSenderId: "1021027927345",
          appId: "1:1021027927345:web:38ead23d9f561aa1121c10",
          measurementId: "G-CGM5WCT56R"
        };
        
        // Canvas environment variables (if running in canvas) take precedence
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : providedFirebaseConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app-id';
        const initialAuthToken = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : null;
        // =====================

        // State
        // Check if we have a valid configuration to attempt Firebase connection
        let useFirebase = Boolean(firebaseConfig.projectId && firebaseConfig.apiKey && firebaseConfig.projectId !== "productivity-tracker-53afe");
        let app = null, db = null, auth = null;
        let currentUserId = null;
        let isAuthReady = false;
        let dateStatuses = {}; // { '2025-09-27': 'dark-green', ... }

        // --- Utility Functions ---

        /**
         * Formats a Date object to YYYY-MM-DD string.
         */
        const formatDate = d => d.toISOString().split('T')[0];

        /**
         * Generates an array of dates from the fixed start date (Sept 27, 2025) until June 30th, 2026.
         */
        const generateDateRange = () => {
            // FIX: Set a fixed start date (September 27, 2025) to ensure the chain starts correctly.
            const startDate = new Date(2025, 8, 27); // Month 8 is September (0-indexed)
            startDate.setHours(0,0,0,0); 

            // End date remains dynamic relative to the fixed start date's year
            const endDate = new Date(startDate.getFullYear() + (startDate.getMonth() > 5 ? 1 : 0), 5, 30); // June 30 next year
            endDate.setHours(0,0,0,0);
            
            const out = []; 
            let cur = new Date(startDate);
            while (cur <= endDate) { out.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
            return out;
        };
        
        /**
         * Renders the calendar grid based on the generated dates and current statuses.
         */
        const renderCalendar = (dates) => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            container.innerHTML = '';
            const todayStr = formatDate(new Date());
            let currentMonth = null;

            dates.forEach(date => {
                const ds = formatDate(date);
                // Use month and year for unique month identifier
                const month = date.getMonth() + '-' + date.getFullYear(); 

                // Check if the month has changed to insert a header
                if (currentMonth !== month) {
                    const mh = document.createElement('div');
                    mh.className = 'month-header';
                    mh.textContent = date.toLocaleDateString('en-US', { month:'long', year:'numeric' });
                    container.appendChild(mh);
                    currentMonth = month;
                }

                const tile = document.createElement('div');
                tile.className = 'date-tile';
                tile.dataset.date = ds;

                // Add today marker
                if (ds === todayStr) {
                    tile.classList.add('today');
                }

                // Add the content container
                const content = document.createElement('div');
                content.className = 'date-tile-content';
                content.textContent = date.getDate();
                tile.appendChild(content);

                // Apply status color based on 4-level system
                const st = dateStatuses[ds];
                if (st === 'dark-green') tile.classList.add('status-dark-green');
                else if (st === 'light-green') tile.classList.add('status-light-green');
                else if (st === 'light-red') tile.classList.add('status-light-red');
                else if (st === 'deep-red') tile.classList.add('status-deep-red');

                // Add click listener
                tile.addEventListener('click', handleClick);
                
                container.appendChild(tile);
            });
        };

        /**
         * Handles the click event, cycling through the 5 states (4 colors + null).
         */
        const handleClick = (event) => {
            // Ensure ready state
            if (!isAuthReady || !currentUserId) {
                console.warn('Click ignored: not ready.');
                document.getElementById('status-message').textContent = 'Please wait for initialization...';
                return;
            }

            const tile = event.currentTarget;
            const dateString = tile.dataset.date;

            // Decide next state based on current cache
            const cur = dateStatuses[dateString] || null;
            let next = null;
            
            // 5-State Cycle Logic
            switch (cur) {
                case null:
                    next = 'dark-green'; // Neutral -> Dark Green (Happy)
                    break;
                case 'dark-green':
                    next = 'light-green'; // Dark Green -> Light Green (Satisfied)
                    break;
                case 'light-green':
                    next = 'light-red'; // Light Green -> Light Red (Minimal work)
                    break;
                case 'light-red':
                    next = 'deep-red'; // Light Red -> Deep Red (Wasted time)
                    break;
                case 'deep-red':
                    next = null; // Deep Red -> Neutral (Clear)
                    break;
                default:
                    next = 'dark-green'; 
            }
            
            // Persist the change to storage (Firebase or localStorage)
            saveStatus(dateString, next);
        };

        /**
         * Saves the status to either Firestore (cloud) or localStorage (local).
         */
        const saveStatus = async (dateString, status) => {
            if (useFirebase) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/productivity_tracker`, dateString);
                    if (status) {
                        await setDoc(docRef, { status, timestamp: Timestamp.now() });
                        console.log('Saved to Firestore:', dateString, status);
                    } else {
                        await deleteDoc(docRef);
                        console.log('Deleted from Firestore:', dateString);
                    }
                } catch (err) {
                    console.error('Firestore save error:', err);
                }
            } else {
                // Local mode -> persist to localStorage
                try {
                    const key = `local_prod_${currentUserId}`;
                    const storage = JSON.parse(localStorage.getItem(key) || '{}');
                    if (status) storage[dateString] = status;
                    else delete storage[dateString];
                    localStorage.setItem(key, JSON.stringify(storage));
                    
                    // Manually trigger local render to simulate the delayed update
                    loadLocalDataAndRender(currentUserId); 
                    
                    console.log('Local saved:', dateString, status);
                } catch (err) {
                    console.error('Local save error:', err);
                }
            }
        };
        
        /**
         * Loads data from localStorage and renders the calendar.
         */
        const loadLocalDataAndRender = (userId) => {
             const key = `local_prod_${userId}`;
             const storage = JSON.parse(localStorage.getItem(key) || '{}');
             dateStatuses = storage;
             renderCalendar(generateDateRange());
             console.log('Local data loaded.');
        }

        /**
         * Sets up the listener to fetch data from Firestore or localStorage.
         */
        const listenForUpdates = (userId) => {
            currentUserId = userId;
            const statusEl = document.getElementById('status-message');

            if (useFirebase) {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/productivity_tracker`);
                // Listen for changes in real-time (this naturally provides the delay)
                onSnapshot(collectionRef, (snapshot) => {
                    const newStatuses = {};
                    snapshot.forEach(docSnap => {
                        const d = docSnap.data();
                        // Only accept the four valid status strings
                        if (['dark-green', 'light-green', 'light-red', 'deep-red'].includes(d.status)) {
                             newStatuses[docSnap.id] = d.status;
                        }
                    });
                    dateStatuses = newStatuses;
                    renderCalendar(generateDateRange());
                    console.log('Firestore snapshot applied.');
                }, (err) => {
                    console.error('Snapshot error:', err);
                    statusEl.textContent = 'Error syncing with Firestore (check console).';
                });
            } else {
                // Initial load from local storage
                loadLocalDataAndRender(userId);
            }
        };
        
        /**
         * Initializes local mode when Firebase config is missing.
         */
        function initLocalMode(statusEl) {
            // Create/get a stable local user id so data key is stable across page reloads
            let localId = localStorage.getItem('prod_local_userid');
            if (!localId) { localId = 'local-' + Math.random().toString(36).slice(2,10); localStorage.setItem('prod_local_userid', localId); }
            currentUserId = localId;
            isAuthReady = true;
            document.getElementById('user-id').textContent = currentUserId + ' (local)';
            statusEl.textContent = 'Local demo mode — data stored in this browser.';
            listenForUpdates(currentUserId);
        }

        /**
         * Main setup function.
         */
        const setup = async () => {
            const statusEl = document.getElementById('status-message');
            
            if (useFirebase) {
                // Cloud Sync Mode
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    try { setLogLevel('debug'); } catch (e) { /* ignore */ } // Set log level

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                currentUserId = auth.currentUser?.uid || null;
                            } else {
                                // Sign in anonymously for a unique ID tied to the Firebase project
                                const anon = await signInAnonymously(auth);
                                currentUserId = anon.user.uid;
                            }
                        }

                        if (currentUserId) {
                            isAuthReady = true;
                            document.getElementById('user-id').textContent = currentUserId;
                            statusEl.textContent = 'Connected to Firestore — ready.';
                            listenForUpdates(currentUserId);
                        }
                    });
                } catch (err) {
                    console.error('Firebase init error, switching to local mode:', err);
                    // Fallback if Firebase initialization fails
                    useFirebase = false;
                    initLocalMode(statusEl);
                }
            } else {
                // Local Demo Mode
                initLocalMode(statusEl);
            }
        };

        // Run setup on window load
        window.addEventListener('load', setup);
    </script>
</head>
<body class="flex justify-center items-start">

    <div class="panel p-6 bg-white shadow-lg rounded-xl">
        <header class="mb-4 pb-3 border-b">
            <h1 class="text-3xl font-extrabold text-gray-800">The Productivity Chain (4 Levels)</h1>
            <p class="text-sm text-gray-500 mt-1">Visualize your consistency from September 27, 2025, until June 30, 2026.</p>
        </header>

        <!-- Instructions and Status -->
        <div class="mb-4 p-3 bg-indigo-50 rounded-md border border-indigo-200">
            <div class="text-sm text-indigo-700 font-semibold">Instructions: Click to cycle through the 4 levels</div>
            <ul class="text-sm text-gray-700 mt-2 list-disc list-inside space-y-1">
                <li>$\to$ <span class="font-bold text-emerald-600">Dark Green:</span> Happy with my work (Maximum Productivity).</li>
                <li>$\to$ <span class="font-bold text-emerald-400">Light Green:</span> Did work, but not to my satisfaction level.</li>
                <li>$\to$ <span class="font-bold text-red-400">Light Red:</span> Did work, but very little (Minimal Productivity).</li>
                <li>$\to$ <span class="font-bold text-red-600">Deep Red:</span> Wasted time (Bad Work Day).</li>
                <li>$\to$ Neutral (clears the status).</li>
            </ul>
        </div>
        
        <!-- User ID & Status Message -->
        <div class="text-xs text-gray-500 mb-3">
            <span id="status-message" class="font-medium text-blue-600">Initializing...</span>
            <span class="ml-3">User: <span id="user-id" class="font-mono">—</span></span>
        </div>

        <!-- Scroll wrapper; month headers are sticky within this -->
        <div id="calendar-scroll" class="rounded-md bg-white">
            <div id="calendar-container" class="calendar-grid p-3">
                <!-- Calendar days will be rendered here by JavaScript -->
                <div class="month-header">Loading calendar…</div>
            </div>
        </div>

    </div>

</body>
</html>
