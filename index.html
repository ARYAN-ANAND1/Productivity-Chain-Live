<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Productivity Chain Tracker (Google Sign-In Only)</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
/>

<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ["Inter", "sans-serif"],
        },
        colors: {
          "current-day-blue": "#3b82f6",
          // Adding specific color variables for CSS access
          'dark-green': '#059669',
          'light-green': '#a7f3d0',
          'light-red': '#fecaca',
          'deep-red': '#ef4444',
        },
      },
    },
  };
</script>

<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");

  body {
    font-family: "Inter", sans-serif;
    background: linear-gradient(135deg, #eef2ff 0%, #e0f2fe 100%);
    min-height: 100vh;
    padding: 2rem;
    display: flex;
    justify-content: center;
  }

  .panel {
    width: 100%;
    max-width: 960px;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
  }

  .panel:hover {
    transform: translateY(-3px);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.1);
  }

  header {
    background: linear-gradient(90deg, #2563eb, #4f46e5);
    border-radius: 1rem 1rem 0 0;
    color: white;
    padding: 1.5rem;
  }

  header h1 {
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  header p {
    color: #e0e7ff;
  }

  #auth-controls button {
    transition: all 0.25s ease;
  }

  #auth-controls button:hover {
    transform: scale(1.05);
  }

  #calendar-scroll {
    max-height: 72vh;
    overflow-y: auto;
    background: #f9fafb;
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(52px, 1fr));
    gap: 10px;
  }

  .month-header {
    grid-column: 1 / -1;
    font-weight: 700;
    font-size: 1.1rem;
    margin-top: 1rem;
    color: #1e293b;
    background: linear-gradient(90deg, #e0f2fe, #f0f9ff);
    padding: 0.4rem 0.75rem;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .date-tile {
    position: relative;
    width: 100%;
    padding-top: 100%;
    border-radius: 12px;
    cursor: pointer;
    background-color: white;
    font-weight: 700;
    color: #374151;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
    /* Default inactive state */
    opacity: 0.5;
    pointer-events: none;
  }
  
  .date-tile.active {
      opacity: 1;
      pointer-events: auto;
  }

  .date-tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  }

  .date-tile-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* --- Enhanced Status Colors --- */
  .status-dark-green {
    background: linear-gradient(145deg, #047857, #059669);
    color: #ffffff !important;
    box-shadow: 0 8px 16px rgba(5, 150, 105, 0.35);
  }

  .status-light-green {
    background: linear-gradient(145deg, #a7f3d0, #6ee7b7);
    color: #064e3b !important;
  }

  .status-light-red {
    background: linear-gradient(145deg, #fecaca, #fca5a5);
    color: #7f1d1d !important;
  }

  .status-deep-red {
    background: linear-gradient(145deg, #ef4444, #b91c1c);
    color: #ffffff !important;
  }

  .today {
    outline: 3px solid #3b82f6;
    outline-offset: -3px;
  }

  .info-box {
    background: #eef2ff;
    border: 1px solid #c7d2fe;
    color: #3730a3;
    padding: 1rem;
    border-radius: 8px;
  }

  #status-message {
    background: linear-gradient(90deg, #e0f2fe, #f0f9ff);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    body {
      padding: 1rem;
    }

    .calendar-grid {
      gap: 6px;
      grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
    }

    header h1 {
      font-size: 1.6rem;
    }
  }
</style>
</head>

<body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // === FIREBASE CONFIGURATION ===
    const firebaseConfig = {
      apiKey: "AIzaSyD4xb2VjkVI6LBnfr_R0IMdRtMNnl5K2uI",
      authDomain: "productivity-tracker-53afe.firebaseapp.com",
      projectId: "productivity-tracker-53afe",
      storageBucket: "productivity-tracker-53afe.appspot.com",
      messagingSenderId: "1021027927345",
      appId: "1:1021027927345:web:38ead23d9f561aa1121c10",
    };
    
    const appId = firebaseConfig.projectId; 
    const PROGRESS_COLLECTION_NAME = 'single_chain_tracker'; // Dedicated collection name
    
    // State
    let app, db, auth;
    let currentUserId = null;
    let isAuthReady = false;
    let dateStatuses = {}; // Progress for the calendar: { 'YYYY-MM-DD': 'dark-green' }

    // --- AUTHENTICATION FUNCTIONS ---
    const googleProvider = new GoogleAuthProvider();

    const signInWithGoogle = async () => {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            console.error("Google Sign-In Failed:", error);
            document.getElementById('status-message').textContent = 'Sign-In Failed. Check console/network.';
        }
    };

    const handleSignOut = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Sign-Out Failed:", error);
        }
    };

    // --- DATA MANAGEMENT FUNCTIONS ---

    const formatDate = d => d.toISOString().split('T')[0];

    const generateDateRange = () => {
        // Fixed date range: Jan 5, 2026 to June 30, 2026
        const startDate = new Date(2026, 0, 5); 
        startDate.setHours(0,0,0,0); 
        const endDate = new Date(2026, 5, 30);
        endDate.setHours(0,0,0,0);
        
        const out = []; 
        let cur = new Date(startDate);
        while (cur <= endDate) { 
            out.push(new Date(cur)); 
            cur.setDate(cur.getDate()+1); 
        }
        return out;
    };
    
    const renderCalendar = (dates, signedIn) => {
        const container = document.getElementById('calendar-container');
        if (!container) return;
        container.innerHTML = '';
        
        const todayStr = formatDate(new Date());
        let currentMonth = null;
        const statusMap = { 'dark-green': 'status-dark-green', 'light-green': 'status-light-green', 'light-red': 'status-light-red', 'deep-red': 'status-deep-red' };

        dates.forEach(date => {
            const ds = formatDate(date);
            const month = date.getMonth() + '-' + date.getFullYear(); 

            if (currentMonth !== month) {
                const mh = document.createElement('div');
                mh.className = 'month-header';
                mh.textContent = date.toLocaleDateString('en-US', { month:'long', year:'numeric' });
                container.appendChild(mh);
                currentMonth = month;
            }

            const status = dateStatuses[ds];
            const statusClass = status ? statusMap[status] : '';
            
            const tile = document.createElement('div');
            // Tile is only clickable/active if signed in AND the date is today or in the past
            const isActive = signedIn && ds <= todayStr;
            const activeClass = isActive ? 'active' : '';

            tile.className = `date-tile ${statusClass} ${activeClass}`;
            tile.dataset.date = ds;
            
            if (ds === todayStr) tile.classList.add('today');

            const content = document.createElement('div');
            content.className = 'date-tile-content';
            content.textContent = date.getDate();
            tile.appendChild(content);

            if (isActive) {
                tile.addEventListener('click', () => handleCalendarClick(ds, tile));
            }
            
            container.appendChild(tile);
        });
    };

    const handleCalendarClick = (dateString, tile) => {
        if (!isAuthReady || !currentUserId) return;

        const cur = dateStatuses[dateString] || null;
        let next = null;
        
        // 4-level cycle logic
        switch (cur) {
            case null: next = 'dark-green'; break;
            case 'dark-green': next = 'light-green'; break;
            case 'light-green': next = 'light-red'; break;
            case 'light-red': next = 'deep-red'; break;
            case 'deep-red': next = null; break;
            default: next = 'dark-green'; 
        }
        
        // Optimistic UI Update 
        dateStatuses[dateString] = next;
        tile.classList.remove('status-dark-green', 'status-light-green', 'status-light-red', 'status-deep-red');
        if (next) {
            tile.classList.add(`status-${next}`);
        }

        saveStatus(dateString, next);
    };

    const saveStatus = async (dateString, status) => {
        try {
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${PROGRESS_COLLECTION_NAME}`, dateString);
            
            if (status) {
                await setDoc(docRef, { status, timestamp: Timestamp.now() });
            } else {
                await deleteDoc(docRef);
            }
            
            document.getElementById('status-message').textContent = `Status updated for ${dateString}.`;
        } catch (err) {
            console.error('Firestore save error:', err);
            document.getElementById('status-message').textContent = 'Save Failed! Check console for security rule errors.';
        }
    };
    
    const listenForProgress = (userId) => {
        const statusEl = document.getElementById('status-message');
        
        const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/${PROGRESS_COLLECTION_NAME}`);
        onSnapshot(collectionRef, (snapshot) => {
            const newStatuses = {};
            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                if (['dark-green', 'light-green', 'light-red', 'deep-red'].includes(d.status)) {
                    newStatuses[docSnap.id] = d.status;
                }
            });
            dateStatuses = newStatuses;
            renderCalendar(generateDateRange(), true); // Re-render active calendar
            statusEl.textContent = 'Connected to Firestore — Data synchronized.';
        }, (err) => {
            console.error('Snapshot error:', err);
            statusEl.textContent = 'Error syncing with Firestore (check console).';
        });
    };
    
    // --- Initialization ---
    const setup = async () => {
        // Initialize Firebase services
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Bind functions for HTML use
        window.signInWithGoogle = signInWithGoogle;
        window.handleSignOut = handleSignOut;

        onAuthStateChanged(auth, (user) => {
            const dates = generateDateRange();
            
            if (user) {
                // USER IS SIGNED IN
                currentUserId = user.uid;
                isAuthReady = true;
                
                document.getElementById('user-name').textContent = user.displayName || 'Google User';
                document.getElementById('user-id-display').textContent = user.uid.substring(0, 10) + '...'; // Shorten ID for display
                
                document.getElementById('auth-prompt').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');

                listenForProgress(currentUserId);
            } else {
                // USER IS SIGNED OUT
                currentUserId = null;
                isAuthReady = false;
                dateStatuses = {};

                document.getElementById('auth-prompt').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('status-message').textContent = 'Please sign in with Google to start tracking.';
                
                renderCalendar(dates, false); // Render inactive calendar
            }
        });
    };

    window.addEventListener('load', setup);
  </script>
  
  <div class="panel">
    <header class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl">The Productivity Chain</h1>
        <p class="text-sm mt-1">Cross-device consistency via Google Sign-In.</p>
      </div>

      <div id="auth-controls" class="text-right">
        <div id="user-info" class="hidden">
          <p class="text-sm font-semibold">
            Welcome, <span id="user-name" class="text-white"></span>!
          </p>
          <button
            id="sign-out-btn"
            onclick="window.handleSignOut()"
            class="mt-1 text-xs text-red-100 hover:text-white font-medium"
          >
            Sign Out
          </button>
        </div>

        <div id="auth-prompt">
          <button
            id="google-sign-in-btn"
            onclick="window.signInWithGoogle()"
            class="bg-white text-blue-600 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-50 flex items-center"
          >
            <i class="fab fa-google mr-2"></i>
            Sign in with Google
          </button>
        </div>
      </div>
    </header>

    <div class="p-6 space-y-4">
      <div class="info-box">
        <div class="font-semibold">Instructions:</div>
        <ul class="list-disc list-inside mt-2 text-sm space-y-1">
          <li><span class="font-bold text-emerald-600">Dark Green:</span> Maximum productivity.</li>
          <li><span class="font-bold text-emerald-400">Light Green:</span> Good day, but not best.</li>
          <li><span class="font-bold text-red-400">Light Red:</span> Low output day.</li>
          <li><span class="font-bold text-red-600">Deep Red:</span> Wasted day.</li>
          <li>Neutral (clears the status).</li>
        </ul>
      </div>

      <div class="text-xs text-gray-600 flex items-center gap-2">
        <span id="status-message">Initializing...</span>
        <span>User ID: <span id="user-id-display" class="font-mono">—</span></span>
      </div>

      <div id="calendar-scroll">
        <div id="calendar-container" class="calendar-grid p-3">
          <div class="month-header">Loading calendar…</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
